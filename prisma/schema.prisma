// This is the Prisma schema for the Loterie de Noël project
// Defines the database structure for participants, lotteries, gift ideas, exclusions, draws, and managers

generator client {
  provider = "prisma-client-js"
}

// Configuration de la base de données
// 
// Pour le développement et petits déploiements, SQLite est suffisant :
//   provider = "sqlite"
//   DATABASE_URL = "file:./prisma/dev.db"
//
// Pour la production avec plusieurs utilisateurs simultanés, PostgreSQL est recommandé :
//   1. Changer provider = "postgresql"
//   2. Configurer DATABASE_URL = "postgresql://user:password@localhost:5432/loterie_noel?schema=public"
//   3. Exécuter: npx prisma migrate deploy
//   4. Exécuter: npx prisma generate
//
// Voir deployment/database-migration.md pour le guide complet de migration.
datasource db {
  provider = "postgresql"  // Migration vers PostgreSQL effectuée
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String
  password  String? // Hash du mot de passe ou null si connexion par email magic link
  createdAt DateTime  @default(now())
  lotteries Lottery[] // Les loteries qu'il a créées
}

model Lottery {
  id           String        @id @default(uuid())
  name         String
  year         Int
  createdAt    DateTime      @default(now())
  ownerId      String // Qui a créé cette loterie
  owner        User          @relation(fields: [ownerId], references: [id])
  participants Participant[]
  exclusions   Exclusion[]
  draws        Draw[]
}

model Participant {
  id              String               @id @default(uuid())
  name            String
  email           String?
  isActive        Boolean
  lotteryId       String
  lottery         Lottery              @relation(fields: [lotteryId], references: [id])
  createdAt       DateTime             @default(now())
  giftIdeas       GiftIdea[]
  exclusions      Exclusion[]          @relation("ParticipantExclusions")
  excluded        Exclusion[]          @relation("ExcluExclusions")
  giverDraws      Draw[]               @relation("GiverDraw")
  receiverDraws   Draw[]               @relation("ReceiverDraw")
  managedChildren ParticipantManager[] @relation("Manager")
  managers        ParticipantManager[] @relation("Child")
}

model GiftIdea {
  id            String      @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  title         String
  description   String?
  link          String?
  createdAt     DateTime    @default(now())
}

model Exclusion {
  id            String      @id @default(uuid())
  lotteryId     String
  lottery       Lottery     @relation(fields: [lotteryId], references: [id])
  participantId String
  participant   Participant @relation("ParticipantExclusions", fields: [participantId], references: [id])
  excludedId    String
  excluded      Participant @relation("ExcluExclusions", fields: [excludedId], references: [id])
}

model Draw {
  id         String      @id @default(uuid())
  lotteryId  String
  lottery    Lottery     @relation(fields: [lotteryId], references: [id])
  giverId    String
  giver      Participant @relation("GiverDraw", fields: [giverId], references: [id])
  receiverId String
  receiver   Participant @relation("ReceiverDraw", fields: [receiverId], references: [id])
}

model ParticipantManager {
  id        String      @id @default(uuid())
  childId   String
  child     Participant @relation("Child", fields: [childId], references: [id])
  managerId String
  manager   Participant @relation("Manager", fields: [managerId], references: [id])
}
