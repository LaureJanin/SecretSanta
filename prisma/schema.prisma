// This is the Prisma schema for the Loterie de Noël project
// Defines the database structure for participants, lotteries, gift ideas, exclusions, draws, and managers

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String      @id @default(uuid())
  email     String      @unique
  name      String
  password  String?     // Hash du mot de passe ou null si connexion par email magic link
  createdAt DateTime    @default(now())
  lotteries Lottery[]   // Les loteries qu'il a créées
}

model Lottery {
  id        String      @id @default(uuid())
  name      String
  year      Int
  createdAt DateTime    @default(now())
  ownerId   String      // Qui a créé cette loterie
  owner     User        @relation(fields: [ownerId], references: [id])
  participants Participant[]
  exclusions   Exclusion[]
  draws        Draw[]
}

model Participant {
  id            String      @id @default(uuid())
  name          String
  email         String?     @unique
  loginCode     String?     @unique
  isActive      Boolean     // true = participates in the lottery, false = child/non-drawing profile
  lotteryId     String
  lottery       Lottery     @relation(fields: [lotteryId], references: [id])
  createdAt     DateTime    @default(now())
  giftIdeas     GiftIdea[]
  exclusions    Exclusion[] @relation("ParticipantExclusions")
  excluded      Exclusion[] @relation("ExcluExclusions")
  giverDraws    Draw[]      @relation("GiverDraw")
  receiverDraws Draw[]      @relation("ReceiverDraw")
  managedChildren ParticipantManager[] @relation("Manager")
  managers      ParticipantManager[] @relation("Child")
}

model GiftIdea {
  id            String   @id @default(uuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id])
  title         String
  description   String?
  link          String?
  createdAt     DateTime @default(now())
}

model Exclusion {
  id            String   @id @default(uuid())
  lotteryId     String
  lottery       Lottery  @relation(fields: [lotteryId], references: [id])
  participantId String
  participant   Participant @relation("ParticipantExclusions", fields: [participantId], references: [id])
  excludedId    String
  excluded      Participant @relation("ExcluExclusions", fields: [excludedId], references: [id])
}

model Draw {
  id            String   @id @default(uuid())
  lotteryId     String
  lottery       Lottery  @relation(fields: [lotteryId], references: [id])
  giverId       String
  giver         Participant @relation("GiverDraw", fields: [giverId], references: [id])
  receiverId    String
  receiver      Participant @relation("ReceiverDraw", fields: [receiverId], references: [id])
}

model ParticipantManager {
  id         String      @id @default(uuid())
  childId    String
  child      Participant @relation("Child", fields: [childId], references: [id])
  managerId  String
  manager    Participant @relation("Manager", fields: [managerId], references: [id])
}
